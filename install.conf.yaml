# this script should be idempotent on a fully configured system
# run with $ sudo ~/.dotfiles./install
# dotbot configuration, used by ~/.dotfiles/install
# https://github.com/anishathalye/dotbot

- defaults:
    link:
        create: true
        relink: true
        ignore-missing: true # creates link even if destination doesn't exist yet
#TODO: make shell defaults:
# quiet: true
# stderr: true

- clean: ['~'] # remove broken symlinks

#  - [git submodule update --init --recursive, Installing submodules] #TODO: where should we put this?

# link: create symlinks to dotfiles
# TODO:if the file already exists, its contents have to be moved first (?)
# ~/foo: is shorthand for ~/foo: ~/.dotfiles/foo, which in turn means to create a symlink at ~/foo, which points to the filepath ~/.dotfiles/foo.
# CAUTION: this will makes links asuming the destination has unhidden file names. To keep the dot at the beginning, the dest muc be listed manually.
# I want to keep .zshenv, .zshrc, and some other config files in ~/.dotfiles for version control and backup.
# I want .zshenv and .zshrc to remain in $HOME, because it's easy to source them from there.
# I also want them to exist in $ZDOTDIR, which should be set to $HOME/.config/zsh in accordance with XDG specifications.
# The links to $ZDOTDIR won't work until after .zshenv is sourced, because that's where the export command lies.
- link:
    ~/.gitconfig: ~/.dotfiles/.gitconfig
    ~/.zshenv: ~/.dotfiles/.config/zsh/.zshenv
    ~/.zshrc: ~/.dotfiles/.config/zsh/.zshrc

    # ~/.dircolors: ~/.dotfiles/.dircolors
    # ~/history: $XDG_CACHE_HOME/zsh/zcompdump-$ZSH_VERSION #TODO: fix; $ expansion not working

#TODO: move most of this to a bash/sh script? This would be less verbose and less reliant on dotbot
#TODO: move command defaults to top once it's working (currently doesn't work)
- shell:
    - 
        command: sudo apt-get install -y zsh #apt-get preferred to apt for scripts
        description: installing zsh
        quiet: true
        stderr: true
    -
        command: sudo chsh -s $(which zsh)
        description: setting zsh as the default shell
        quiet: true
        stderr: true
    - 
        command: git config --global init.defaultBranch main
        quiet: true
        stderr: true
    - 
        command: git config --global user.name 'Ian Beckett'
        description: configuring git
        quiet: true
        stderr: true
    - 
        command: git config --global user.email '41558014+ianebeckett@users.noreply.github.com'
        quiet: true
        stderr: true
          #    -
          #        command: git config --global diff.colorMoved zebra
          #        quiet: true
          #        stderr: true

#TODO:  do all these in the right order:
# mkdir # ~/.config/zsh
# make ZDOTDIR and XDG dirs
# zshenv: export ZDOTDIR, XDG etc.
# eg zshenv: export ZDOTDIR="$HOME/.config/zsh"
# move .zcompdump to $ZDOTDIR
# move .zsh_history to $ZDOTDIR (?)
# link $ZDOTDIR/.zshenv to ~/.zshenv (or to ~/.dotfiles/.zshenv?)
# link $ZDOTDIR/.zshrc to ~/.zshrc (or to ~/.dotfiles/.zshrc?)

#TODO: fix automated font setup
# preferred fonts: JetBrains Mono > Ubuntu Mono > Cascadia Mono > family: monospace
# confirm font installed correctly by running fc-list | grep "<name-of-font>"
  # - command: fc-cache -fv # build font #TODO: use -E, check retval and print on error?
  #   stdout: false
  #   stderr: true
  #- 
  #  command: ./test.zsh # run test script #TODO: must scripts be compatible with the system's default shell, or does shebang zsh work?
  #  stdout: true
  #  stderr: true
#  - 
#   command: ssh-keygen -t ed25519 -C ian@$(cat /etc/hostname) #TODO: should this comment be based on my git email, or my hostname? 
#    description: "generating ssh key. See add-ssh-key.txt for instructions."
#    quiet: true
#    stdout: true
#    stderr: true
